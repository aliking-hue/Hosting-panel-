{% extends "base.html" %}

{% block title %}My Scripts - Dark Hosting Panel{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="card-title mb-0">
                            <i class="bi bi-file-code"></i> My Scripts
                        </h2>
                        <a href="{{ url_for('upload') }}" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Upload New Script
                        </a>
                    </div>
                    <p class="card-text text-secondary mt-2">
                        You have {{ current_count }} out of {{ file_limit }} scripts.
                        {% if current_count >= file_limit %}
                        <span class="text-warning">File limit reached!</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-list"></i> Script List
                </div>
                <div class="card-body">
                    {% if scripts %}
                    <div class="table-responsive">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>Filename</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Uploaded</th>
                                    <th>Actions</th>
                                    <th>Console</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for script in scripts %}
                                <tr>
                                    <td>
                                        <i class="bi bi-file-{% if script.filetype == 'py' %}python{% else %}code{% endif %}"></i>
                                        {{ script.filename }}
                                    </td>
                                    <td>
                                        <span class="badge bg-{% if script.filetype == 'py' %}warning{% else %}info{% endif %}">
                                            {{ script.filetype|upper }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if script.status == 'running' %}
                                        <span class="badge bg-success pulse">
                                            <i class="bi bi-play-circle"></i> Running
                                        </span>
                                        {% else %}
                                        <span class="badge bg-danger">
                                            <i class="bi bi-stop-circle"></i> Stopped
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ script.upload_time[:19] }}</small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            {% if script.status != 'running' %}
                                            <a href="{{ url_for('start_script', script_id=script.id) }}" 
                                               class="btn btn-outline-success" title="Start">
                                                <i class="bi bi-play"></i>
                                            </a>
                                            {% else %}
                                            <a href="{{ url_for('stop_script', script_id=script.id) }}" 
                                               class="btn btn-outline-warning" title="Stop">
                                                <i class="bi bi-stop"></i>
                                            </a>
                                            {% endif %}
                                            
                                            <a href="#" class="btn btn-outline-info" 
                                               onclick="showLogs({{ script.id }})" title="View Logs">
                                                <i class="bi bi-terminal"></i>
                                            </a>
                                            
                                            <a href="{{ url_for('delete_script', script_id=script.id) }}" 
                                               class="btn btn-outline-danger" 
                                               onclick="return confirm('Are you sure you want to delete this script?')" 
                                               title="Delete">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-secondary" 
                                                onclick="openConsole({{ script.id }}, '{{ script.filename }}')">
                                            <i class="bi bi-terminal"></i> Open Console
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-file-code display-1 text-secondary"></i>
                        <h3 class="mt-3">No scripts uploaded yet</h3>
                        <p class="text-secondary">Upload your first script to get started</p>
                        <a href="{{ url_for('upload') }}" class="btn btn-primary mt-2">
                            <i class="bi bi-upload"></i> Upload Script
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Actions -->
    {% if scripts %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-gear"></i> Bulk Actions
                </div>
                <div class="card-body">
                    <div class="btn-group">
                        <button class="btn btn-outline-success" onclick="startAllScripts()">
                            <i class="bi bi-play-circle"></i> Start All
                        </button>
                        <button class="btn btn-outline-warning" onclick="stopAllScripts()">
                            <i class="bi bi-stop-circle"></i> Stop All
                        </button>
                        <button class="btn btn-outline-danger" onclick="confirmDeleteAll()">
                            <i class="bi bi-trash"></i> Delete All
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Logs Modal -->
<div class="modal fade" id="logsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logsModalTitle">
                    <i class="bi bi-terminal"></i> Script Logs
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="console" id="scriptLogs" style="height: 400px;">
                    Loading logs...
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-sm btn-outline-success" onclick="refreshLogs()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
                <button class="btn btn-sm btn-outline-primary" onclick="scrollLogs()">
                    <i class="bi bi-arrow-down"></i> Scroll to Bottom
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="clearLogs()">
                    <i class="bi bi-trash"></i> Clear Logs
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Script Console Modal -->
<div class="modal fade" id="scriptConsoleModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-terminal"></i> <span id="consoleTitle">Script Console</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="console" id="scriptConsole" style="height: 500px;">
                    Connecting to script console...
                </div>
                <div class="mt-3">
                    <div class="input-group">
                        <input type="text" id="consoleInput" class="form-control" 
                               placeholder="Enter command (press Enter to send)" 
                               onkeypress="if(event.keyCode==13) sendCommand()">
                        <button class="btn btn-primary" onclick="sendCommand()">
                            <i class="bi bi-send"></i> Send
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-success" onclick="scrollConsoleToBottom()">
                        <i class="bi bi-arrow-down"></i> Scroll
                    </button>
                    <button class="btn btn-sm btn-outline-warning" onclick="clearScriptConsole()">
                        <i class="bi bi-trash"></i> Clear
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="restartScript()">
                        <i class="bi bi-arrow-clockwise"></i> Restart
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentScriptId = null;
    let currentScriptName = '';
    let logInterval = null;
    let consoleInterval = null;
    
    function showLogs(scriptId) {
        currentScriptId = scriptId;
        const modal = new bootstrap.Modal(document.getElementById('logsModal'));
        modal.show();
        refreshLogs();
        
        // Poll for new logs every 3 seconds
        if (logInterval) clearInterval(logInterval);
        logInterval = setInterval(refreshLogs, 3000);
    }
    
    function refreshLogs() {
        if (!currentScriptId) return;
        
        fetch(`/api/script/${currentScriptId}/console`)
            .then(response => response.json())
            .then(data => {
                const logsDiv = document.getElementById('scriptLogs');
                if (data.logs) {
                    logsDiv.innerHTML = data.logs.map(log => 
                        `<div class="console-line">${log}</div>`
                    ).join('');
                } else if (data.error) {
                    logsDiv.innerHTML = `<div class="console-line text-danger">${data.error}</div>`;
                }
                scrollLogs();
            })
            .catch(error => {
                console.error('Error fetching logs:', error);
            });
    }
    
    function scrollLogs() {
        const logsDiv = document.getElementById('scriptLogs');
        logsDiv.scrollTop = logsDiv.scrollHeight;
    }
    
    function clearLogs() {
        if (confirm('Clear all logs for this script?')) {
            const logsDiv = document.getElementById('scriptLogs');
            logsDiv.innerHTML = '<div class="console-line">Logs cleared</div>';
        }
    }
    
    function openConsole(scriptId, scriptName) {
        currentScriptId = scriptId;
        currentScriptName = scriptName;
        
        document.getElementById('consoleTitle').textContent = `Console: ${scriptName}`;
        const modal = new bootstrap.Modal(document.getElementById('scriptConsoleModal'));
        modal.show();
        
        // Start console polling
        startConsolePolling();
    }
    
    function startConsolePolling() {
        if (consoleInterval) clearInterval(consoleInterval);
        
        // Simulate console output (in production, this would be real)
        let line = 0;
        consoleInterval = setInterval(() => {
            const consoleDiv = document.getElementById('scriptConsole');
            const time = new Date().toLocaleTimeString();
            consoleDiv.innerHTML += `<div class="console-line">[${time}] Output line ${++line} from ${currentScriptName}</div>`;
            scrollConsoleToBottom();
        }, 2000);
    }
    
    function sendCommand() {
        const input = document.getElementById('consoleInput');
        const command = input.value.trim();
        
        if (command) {
            const consoleDiv = document.getElementById('scriptConsole');
            const time = new Date().toLocaleTimeString();
            consoleDiv.innerHTML += `<div class="console-line">[${time}] <span class="text-info">&gt;</span> ${command}</div>`;
            
            // Simulate response
            setTimeout(() => {
                consoleDiv.innerHTML += `<div class="console-line">[${new Date().toLocaleTimeString()}] Command executed: ${command}</div>`;
                scrollConsoleToBottom();
            }, 500);
            
            input.value = '';
        }
        
        scrollConsoleToBottom();
    }
    
    function scrollConsoleToBottom() {
        const consoleDiv = document.getElementById('scriptConsole');
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
    }
    
    function clearScriptConsole() {
        if (confirm('Clear console output?')) {
            document.getElementById('scriptConsole').innerHTML = '<div class="console-line">Console cleared</div>';
        }
    }
    
    function restartScript() {
        if (currentScriptId && confirm('Restart this script?')) {
            window.location.href = `/script/${currentScriptId}/start`;
        }
    }
    
    // Clean up intervals when modals close
    document.addEventListener('hidden.bs.modal', function (event) {
        if (event.target.id === 'logsModal' && logInterval) {
            clearInterval(logInterval);
            logInterval = null;
        }
        if (event.target.id === 'scriptConsoleModal' && consoleInterval) {
            clearInterval(consoleInterval);
            consoleInterval = null;
        }
    });
    
    // Bulk actions
    function startAllScripts() {
        if (confirm('Start all stopped scripts?')) {
            // Get all stopped scripts and start them
            fetch('/api/scripts')
                .then(response => response.json())
                .then(data => {
                    const stoppedScripts = data.scripts.filter(s => s.status !== 'running');
                    stoppedScripts.forEach(script => {
                        window.open(`/script/${script.id}/start`, '_blank');
                    });
                    setTimeout(() => location.reload(), 2000);
                });
        }
    }
    
    function stopAllScripts() {
        if (confirm('Stop all running scripts?')) {
            // Get all running scripts and stop them
            fetch('/api/scripts')
                .then(response => response.json())
                .then(data => {
                    const runningScripts = data.scripts.filter(s => s.status === 'running');
                    runningScripts.forEach(script => {
                        window.open(`/script/${script.id}/stop`, '_blank');
                    });
                    setTimeout(() => location.reload(), 2000);
                });
        }
    }
    
    function confirmDeleteAll() {
        if (confirm('WARNING: This will delete ALL your scripts! This cannot be undone.')) {
            // Delete all scripts
            fetch('/api/scripts')
                .then(response => response.json())
                .then(data => {
                    data.scripts.forEach(script => {
                        fetch(`/script/${script.id}/delete`, {method: 'GET'});
                    });
                    setTimeout(() => location.reload(), 2000);
                });
        }
    }
</script>
{% endblock %}
